#!/usr/bin/env bash
set -Eeuo pipefail

LIB="$HOME/.config/theme-system/lib"
source "$LIB/core.sh"
source "$LIB/theme.sh"
source "$LIB/waybar.sh"

theme="$(get_theme)"
theme_dir="$THEME_ROOT/$theme"

# =========================================================
# Apply theme files automatically
# Mirrors: themes/<theme>/.config/... → ~/.config/...
# =========================================================

while IFS= read -r -d '' file; do
    relative="${file#$theme_dir/}"

    # Waybar is handled separately
    case "$relative" in
        .config/waybar/*) continue ;;
        */state/*) continue ;;
    esac

    target="$HOME/$relative"

    mkdir -p "$(dirname "$target")"
    safe_link "$file" "$target"

done < <(find "$theme_dir" -type f -print0)

# =========================================================
# Apply Waybar (theme + mode system)
# =========================================================

apply_waybar

systemctl --user reload-or-restart swaync.service 2>/dev/null || true

notify "Theme applied → $theme"
